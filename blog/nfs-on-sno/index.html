<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    Setting up NFS as a storage class on SNO - QIoT project
    
  </title>

  <meta name="description" content=".">

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.min.css">

  <link rel="stylesheet" href="/assets/vendor/fontawesome-free/css/all.min.css">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/blog/nfs-on-sno/">
  <link rel="alternate" type="application/rss+xml" title="QIoT project" href="/feed.xml">

  
    
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SK96X617FT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-SK96X617FT');
  </script>

  

</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">QIoT project</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
<!--         <li class="nav-item"> -->
<!--           <a class="nav-link" href="/">Home</a> -->
<!--         </li> -->
        <li class="nav-item">
          <a class="nav-link" href="/announcements">Announcements</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/usecases">Use Cases</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/projects">Projects</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog">Blog</a>
        <li class="nav-item">
          <a class="nav-link" href="/community">Community</a>
        </li>
      </ul>
      </ul>
    </div>
  </div>
</nav>

  <!-- Page Header -->

<header class="masthead" style="background-image: url('/assets/images/posts/nfs-on-sno/nas_and_nuc.jpg')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-16 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>Setting up NFS as a storage class on SNO</h1>
            
            <h2 class="subheading">---</h2>
            
            <span class="meta">
            
            
			  
			     
			        
			            <img class="headshot" src="https://www.gravatar.com/avatar/0756ced625c557966c84a3218a2bf24b">
			        
			            <a href="#">Posted by Geoff Newson</a>
			    
			    on May 10, 2022 &middot; <span class="reading-time" title="Estimated read time">
  
   9 mins  read </span>
            
            </span>
            <br>
            <span class="meta">
			  
            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-16 col-md-10 mx-auto">

        <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#summary">Summary</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#nas-configuration-and-testing">NAS configuration and testing</a></li>
<li><a href="#configuring-the-csi-driver-on-openshift">Configuring the CSI driver on OpenShift</a></li>
</ul>
</div>
<div class="paragraph">
<p>.</p>
</div>
<h1 id="summary" class="sect0"><a class="anchor" href="#summary"></a>Summary</h1>
<div class="paragraph">
<p>This guide will show you how to serve NFS from a home NAS (or other NFS share,
referenced as a NAS for the rest of the article) to a Single Node OpenShift (SNO) and consume it as a storage class through the <a href="https://github.com/container-storage-interface/spec/blob/master/spec.md">CSI</a> NFS storage driver.</p>
</div>
<div class="paragraph">
<p>I&#8217;m assuming that you have a Single Node OpenShift installed based on
<a href="https://qiot-project.github.io/blog/sno-on-nuc10/">this previous post</a> and also
a NAS on the local network.  No assumption is made about the NAS but for the
purpose of this guide I&#8217;ll be using NFS served from my Synology NAS.  Other NAS
appliances should work the same based on the settings in the NAS section.</p>
</div>
<h1 id="introduction" class="sect0"><a class="anchor" href="#introduction"></a>Introduction</h1>
<div class="paragraph">
<p>If you deployed the
<a href="https://github.com/qiot-project/qiot-manufacturing-factory-installer">QIOT
factory</a> on SNO on the NUC you&#8217;ll have seen that the PVs needed to be set up as
part of the machineconfig. This means that if any more PVs are required the
machineconfig needs to be updated, causing a restart of OpenShift and a few
minutes of outage before it comes back up.</p>
</div>
<div class="paragraph">
<p>This isn&#8217;t ideal. What if you want more space than is available on the NUC, which only has 256 GB? What if you want to consume storage dynamically rather than defining the machineconfig up front?  What if this needs to change due to unforseen circumstances?</p>
</div>
<div class="paragraph">
<p>If, like me, you&#8217;re running the NUC on a home network and you have a NAS with some spare capacity you might think "maybe I can use some of that storage".  And indeed you can.  The NAS storage can be shared to your SNO and exposed via an NFS storage class.</p>
</div>
<div class="paragraph">
<p>But wait, NFS shouldn&#8217;t be used with OpenShift should it?  Well, that isn&#8217;t always the case and this isn&#8217;t a production system, so why not. :)</p>
</div>
<div class="paragraph">
<p>Step forward
<a href="https://docs.openshift.com/container-platform/4.9/storage/container_storage_interface/persistent-storage-csi.html">Container
Storage Interface</a> (CSI). CSI will provide the ability to add NFS as a storage
type to the SNO and consume it dynamically via a storage class.</p>
</div>
<h1 id="nas-configuration-and-testing" class="sect0"><a class="anchor" href="#nas-configuration-and-testing"></a>NAS configuration and testing</h1>
<div class="paragraph">
<p>I have a Synology NAS device and the instructions for setting up an NFS share
on it are
<a href="https://kb.synology.com/en-global/DSM/tutorial/How_to_access_files_on_Synology_NAS_within_the_local_network_NFS">here</a>
but on the assumption that you will likely have a different type of NAS, or just
want to export an NFS share from another computer, the
configuration of my NFS storage in the exports file is as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/nfs-on-sno/exports.png" alt="exports" width="100%">
</div>
</div>
<div class="paragraph">
<p>While this is maybe not the most secure set up, it allows us to get going relatively
quickly and easily.  You could set a different squash policy (but be careful if
you do), set the hostname or encrypt your folder.</p>
</div>
<div class="paragraph">
<p>Once your NAS is set up, let&#8217;s test it out. I&#8217;m assuming you&#8217;ll be testing on a
linux host so you&#8217;ll need to install the <code>nfs-utils</code> package if on
CentOS/RedHat/Fedora or <code>nfs-common</code> if on Ubuntu.</p>
</div>
<div class="paragraph">
<p>On the linux host, assuming <code>/mnt</code> exists, run <code>sudo mount -t nfs 192.168.50.195:/volume1/sno_nfs /mnt</code>
(drop the sudo if running as root (why are you running as root?)) but feel free
to mount the NFS share wherever suit you.  Create a file in the mounted folder <code>touch /mnt/testing</code>
and unmount the NFS folder <code>cd; sudo umount /mnt</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/nfs-on-sno/mount_nas.png" alt="mount nas" width="75%">
</div>
</div>
<div class="paragraph">
<p>By logging in to the NAS via SSH we can check that the file is created.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/nfs-on-sno/nas_output.png" alt="nas output" width="33%">
</div>
</div>
<div class="paragraph">
<p>With NFS on the NAS confirmed as working let&#8217;s move on to setting up the SNO.</p>
</div>
<h1 id="configuring-the-csi-driver-on-openshift" class="sect0"><a class="anchor" href="#configuring-the-csi-driver-on-openshift"></a>Configuring the CSI driver on OpenShift</h1>
<div class="paragraph">
<p>We&#8217;re setting this up on OpenShift 4.9 running on the NUC.  On a Single Node installation there is no built in support for NFS so we&#8217;re going to add support via a CSI driver.  This will give us the ability not only to use NFS but to add it as a storage class to give us dynamic storage.</p>
</div>
<div class="paragraph">
<p>The CSI NFS driver is still beta software but, for the purposes of this test setup, it is stable enough.</p>
</div>
<div class="paragraph">
<p>The driver can be downloaded from the github repository <a href="https://github.com/openshift/csi-driver-nfs" class="bare">https://github.com/openshift/csi-driver-nfs</a>.  There are multiple ways to install the driver</p>
</div>
<div class="ulist">
<ul>
<li>
<p>helm</p>
</li>
<li>
<p>directly from the internet</p>
</li>
<li>
<p>from a local clone of the repo.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this guide we&#8217;re going with installing from a local copy of the repo, which allows us to look at the code that is being run to see what resources are being created and where.</p>
</div>
<div class="paragraph">
<p>The procedure is documented as option#2
<a href="https://github.com/openshift/csi-driver-nfs/blob/master/docs/install-csi-driver-master.md">here</a> but to save having to follow the link&#8230;&#8203;</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in the terminal, log into your OpenShift cluster with a cluster admin user</p>
<div class="ulist">
<ul>
<li>
<p><code>oc login --token=&lt;token value&gt; --server=https://api.&lt;sno cluster&gt;:6443</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>clone the repo and change into the directory</p>
<div class="ulist">
<ul>
<li>
<p><code>git clone <a href="https://github.com/kubernetes-csi/csi-driver-nfs.git" class="bare">https://github.com/kubernetes-csi/csi-driver-nfs.git</a></code></p>
</li>
<li>
<p><code>cd csi-driver-nfs</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>before running the deploy script take a look at it in your favourite editor and then look at the yaml files that get called so you know what&#8217;s being deployed.</p>
<div class="ulist">
<ul>
<li>
<p><code>vi ./deploy/install-driver.sh</code></p>
</li>
<li>
<p><code>vi ./deploy/csi-nfs-conftoller.yaml</code></p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>run the deploy script</p>
<div class="ulist">
<ul>
<li>
<p><code>./deploy/install-driver.sh master local</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>show output file</p>
</div>
<div class="ulist">
<ul>
<li>
<p>check pods and you should find that they are running</p>
<div class="ulist">
<ul>
<li>
<p><code>oc -n kube-system get pod -o wide -l app=csi-nfs-controller</code></p>
</li>
<li>
<p><code>oc -n kube-system get pod -o wide -l app=csi-nfs-node</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once the CSI driver is deployed successfully we need to define our storage
class.  Note that it is annotated to be the default storage class.  Parameters
specific to the nfs provisioner are described
<a href="https://github.com/openshift/csi-driver-nfs/blob/master/docs/driver-parameters.md">here</a>.</p>
</div>
<div class="paragraph">
<p>Create a file storageclass-nfs.yaml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: nfs-csi
  annotations:
    storageclass.kubernetes.io/is-default-class: 'true'
provisioner: nfs.csi.k8s.io
parameters:
  server: &lt;NAS IP address&gt;
  share: &lt;NFS share&gt;
reclaimPolicy: Delete
volumeBindingMode: Immediate
mountOptions:
  - hard
  - nfsvers=3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the resource in OpenShift, <code>oc create -f storageclass-nfs.yaml</code> and you
should get confirmation that it is created.</p>
</div>
<div class="paragraph">
<p>Now to test it out we&#8217;ll create a new project and deploy an example app that
uses persistent storage.  As our nfs-csi class is set as the default storage
class it should be used.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>oc new-project nfs-test</code></p>
</li>
<li>
<p><code>oc new-app openshift/rails-pgsql-persistent</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Eventually <code>oc status</code> should show something similar to the below and then you
are ready to test.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/nfs-on-sno/deployed_app.png" alt="deployed app" width="100%">
</div>
</div>
<div class="paragraph">
<p>In your browser navigate to the route shown and you should be greeted with a rails application test page.</p>
</div>
<div class="paragraph">
<p><strong>Congratulations!</strong> You now have NFS set up on you SNO!</p>
</div>

        <div id="share-bar">

    <hr>

    <h4>Share this:</h4>

    <div class="share-buttons">
        <a  href="https://www.facebook.com/sharer/sharer.php?u=/blog/nfs-on-sno/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Facebook" >
            <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
              </span>
        </a>
        <a  href="https://twitter.com/intent/tweet?text=Setting up NFS as a storage class on SNO&url=/blog/nfs-on-sno/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Twitter" >
            <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
        </a>
        <a  href="http://www.reddit.com/submit?url=/blog/nfs-on-sno/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Reddit" >
            <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-reddit fa-stack-1x fa-inverse"></i>
              </span>
        </a>
        <a  href="https://www.linkedin.com/shareArticle?mini=true&url=/blog/nfs-on-sno/&title=Setting up NFS as a storage class on SNO&summary=&source=QIoT project"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on LinkedIn" >
            <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
        </a>
        <a  href="mailto:?subject=Setting up NFS as a storage class on SNO&amp;body=Check out this site /blog/nfs-on-sno/"
            title="Share via Email" >
            <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
        </a>
    </div>

</div>

        <hr>

<!--         <div class="clearfix"> -->
<!--            -->
<!--           <a class="btn btn-primary float-left" href="/blog/rhel-on-fitlet2/" data-toggle="tooltip" data-placement="top" title="Install RHEL for Edge on Compulab Fitlet2">&larr; Previous<span class="d-none d-md-inline"> -->
<!--               Post</span></a> -->
<!--            -->
<!--            -->
<!--           <a class="btn btn-primary float-right" href="/blog/red-hat-hackfest-office-hour-kickoff/" data-toggle="tooltip" data-placement="top" title="Red Hat Hackfest Office Hour - Kick off session!">Next<span class="d-none d-md-inline"> -->
<!--               Post</span> &rarr;</a> -->
<!--            -->

	  
	  
	  
	  

        <div class="clearfix">
          
          <a class="btn btn-primary float-left" href="/blog/rhel-on-fitlet2/" data-toggle="tooltip" data-placement="top" title="Install RHEL for Edge on Compulab Fitlet2">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/blog/red-hat-hackfest-office-hour-kickoff/" data-toggle="tooltip" data-placement="top" title="Red Hat Hackfest Office Hour - Kick off session!">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          
        </div>

      </div>
    </div>
  </div>

  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-16 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:qiotproject@gmail.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://twitter.com/qiotproject">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          
          <li class="list-inline-item">
            <a href="https://github.com/qiot-project">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          <li class="list-inline-item">
            <a href="https://join.slack.com/t/https://join.slack.com/t/qiotproject/shared_invite/zt-nuajdyqf-NfQL0dcfCUjFSgoBNng11A">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-slack fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://groups.google.com/u/0/g/qiotproject/qiotproject">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-google fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://calendar.google.com/event?action=TEMPLATE&tmeid=dmFxMzFlZGkxOHVubDcyYm50bjdrcTJxYThfMjAyMTAzMjVUMTYwMDAwWiBxaW90cHJvamVjdEBt&tmsrc=qiotproject%40gmail.com&scp=ALL">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-calendar-plus fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="copyright text-muted"><i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a> | Copyright &copy;  2024</p>
      </div>
    </div>
  </div>
</footer>

  <script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/clean-blog.min.js"></script>

<script src="/assets/scripts.js"></script>




</body>

</html>
