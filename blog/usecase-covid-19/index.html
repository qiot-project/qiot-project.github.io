<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    PoC covid19 - QIoT project
    
  </title>

  <meta name="description" content="Think of how damaged and polluted it was the environment at the moment COVID-19 started spreading… After a few weeks, the spread of the virus became global, ...">

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.min.css">

  <link rel="stylesheet" href="/assets/vendor/fontawesome-free/css/all.min.css">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/blog/usecase-covid-19/">
  <link rel="alternate" type="application/rss+xml" title="QIoT project" href="/feed.xml">

  
    
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SK96X617FT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-SK96X617FT');
  </script>

  

</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">QIoT project</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
<!--         <li class="nav-item"> -->
<!--           <a class="nav-link" href="/">Home</a> -->
<!--         </li> -->
        <li class="nav-item">
          <a class="nav-link" href="/announcements">Announcements</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/usecases">Use Cases</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/projects">Projects</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog">Blog</a>
        <li class="nav-item">
          <a class="nav-link" href="/community">Community</a>
        </li>
      </ul>
      </ul>
    </div>
  </div>
</nav>

  <!-- Page Header -->

<header class="masthead" style="background-image: url('/assets/images/posts/quarkus-native-on-a-raspberry-pi/hardware.jpg')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-16 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>PoC covid19</h1>
            
            <h2 class="subheading">Use-case overview</h2>
            
            <span class="meta">
            
            
			  
			     
			        
			            <img class="headshot" src="https://www.gravatar.com/avatar/58d8a28d588d957040fd5288cc208a41">
			        
			            <a href="#">Posted by Andrea Battaglia</a>
			    
			    on December 01, 2020 &middot; <span class="reading-time" title="Estimated read time">
  
   42 mins  read </span>
            
            </span>
            <br>
            <span class="meta">
			  
            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-16 col-md-10 mx-auto">

        <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#intro">Intro</a></li>
<li><a href="#far-edge">Far Edge</a>
<ul class="sectlevel1">
<li><a href="#hardware">Hardware</a>
<ul class="sectlevel2">
<li><a href="#single-board-computer">Single-board computer</a></li>
<li><a href="#sensor-board">Sensor board</a></li>
<li><a href="#particulate-matter-sensor">Particulate Matter Sensor</a></li>
</ul>
</li>
<li><a href="#software">Software</a>
<ul class="sectlevel2">
<li><a href="#operating-system">Operating System</a></li>
<li><a href="#sensor-service">Sensor Service</a></li>
<li><a href="#edge-service">Edge Service</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#datacenter">Datacenter</a>
<ul class="sectlevel1">
<li><a href="#main-diagram">Main Diagram</a></li>
<li><a href="#platform-architecture">Platform architecture</a>
<ul class="sectlevel2">
<li><a href="#red-hat-openshift-container-platform">Red Hat Openshift Container Platform</a></li>
</ul>
</li>
<li><a href="#software-infrastructure-components">Software infrastructure components</a>
<ul class="sectlevel2">
<li><a href="#a-mq">A-MQ</a></li>
<li><a href="#a-mq-streams">A-MQ Streams</a></li>
<li><a href="#influx-db">Influx DB</a></li>
<li><a href="#postgresql">PostgreSQL</a></li>
<li><a href="#cert-manager">Cert-manager</a></li>
</ul>
</li>
<li><a href="#business-logic-architecture">Business logic architecture</a>
<ul class="sectlevel2">
<li><a href="#registration-service">Registration Service</a></li>
<li><a href="#station-service">Station Service</a></li>
<li><a href="#localization-service">Localization Service</a></li>
<li><a href="#pollutiongas-collector">Pollution/Gas Collector</a></li>
<li><a href="#pollutiongas-storer">Pollution/Gas Storer</a></li>
<li><a href="#importer-service">Importer Service</a></li>
<li><a href="#real-time-dashboard">Real-time Dashboard</a></li>
<li><a href="#dashboard">Dashboard</a></li>
</ul>
</li>
<li><a href="#functional-overview">Functional Overview</a>
<ul class="sectlevel2">
<li><a href="#registration-phase">Registration phase</a></li>
<li><a href="#telemetry-production">Telemetry production</a></li>
<li><a href="#telemetry-validation-and-enrichment">Telemetry validation and enrichment</a></li>
<li><a href="#scalability-of-the-data-flow">Scalability of the data-flow</a></li>
<li><a href="#data-view">Data view</a></li>
</ul>
</li>
<li><a href="#specs">Specs</a>
<ul class="sectlevel2">
<li><a href="#registration-service-2">Registration Service</a></li>
<li><a href="#pollution">Pollution</a></li>
<li><a href="#gas">Gas</a></li>
</ul>
</li>
<li><a href="#historical-data">Historical data</a></li>
</ul>
</li>
<li><a href="#how-to-reproduce">How to reproduce</a></li>
</ul>
</div>
<div class="paragraph">
<p>Think of how damaged and polluted it was the environment at the moment COVID-19 started spreading…
After a few weeks, the spread of the virus became global, with the hard effect of shutting down the whole human activity all over the world.</p>
</div>
<div class="paragraph">
<p>Although the shutdown has been dramatic and brought several difficulties to human beings and to the economy, the environment has benefited from the stop to the industrial activities at the global level.</p>
</div>
<h1 id="intro" class="sect0"><a class="anchor" href="#intro"></a>Intro</h1>
<div class="paragraph">
<p>The main goal is to build an environmental network of sensors to measure the quality of the air during the reopening phase after the peak of the Pandemic.</p>
</div>
<div class="paragraph">
<p>The "Measurement Stations" collect data about several elements in the atmosphere and send the telemetry to the datacenter for elaboration.</p>
</div>
<div class="paragraph">
<p>At the moment, only <strong>GAS</strong> and <strong>PARTICULATES</strong> telemetries are implemented.</p>
</div>
<div class="paragraph">
<p>The community is keen to receive support and contribution around the implementation of additional telemetries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Light</p>
</li>
<li>
<p>Temperature</p>
</li>
<li>
<p>Humidity</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The datacenter stores two types of data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Runtime</strong> - Data collected by the stations</p>
</li>
<li>
<p><strong>Historical</strong> - aggregated data coming from third party data source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and gives an overview of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Runtime analysis</strong> - A real-time dashboard shows real-time data coming in the datacenter.</p>
</li>
<li>
<p><strong>Localized comparison</strong> - The most relevant considerations come from the comparison between the current data collected by the stations and the third party information collected 6 and 12 months before. This specific comparison refers to a specific day in the time-frame</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/data-comparison-timeline.png" alt="data comparison timeline" width="100%">
</div>
</div>
<h1 id="far-edge" class="sect0"><a class="anchor" href="#far-edge"></a>Far Edge</h1>
<div class="paragraph">
<p>The Far Edge edge device represents the implementation of a measurement station.</p>
</div>
<div class="paragraph">
<p>To get an advice about installing the measurement station outside of the building in order to collect PMS telemetry, please refer to the following article: <a href="https://learn.pimoroni.com/tutorial/sandyj/enviro-plus-and-luftdaten-air-quality-station">An outdoor air quality station with Enviro+</a></p>
</div>
<div class="sect1">
<h2 id="hardware"><a class="anchor" href="#hardware"></a>Hardware</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The edge device hardware is made up of two integrated sets of components.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A single-board computer to deploy the business logic</p>
</li>
<li>
<p>A sensor board</p>
</li>
<li>
<p>A PMS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The components are, of course, designed and structured to work smoothly together, so there is no need to bother with the physical checks and testing.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/hardware.jpg" alt="hardware" width="100%">
</div>
</div>
<div class="paragraph">
<p>A deeper look into the hardware specs:</p>
</div>
<div class="sect2">
<h3 id="single-board-computer"><a class="anchor" href="#single-board-computer"></a>Single-board computer</h3>
<div class="paragraph">
<p>The Hardware of choice for the edge is raspberry pi 3 model B+.</p>
</div>
<div class="paragraph">
<p>The Pi 3 Model B+ has a 1.4GHz 64-bit quad-core Broadcom Arm Cortex A53-architecture processor.</p>
</div>
<div class="paragraph">
<p>Choosing the target single-board computer model has been quite an easy task: I already had a Raspberry Pi meeting the requirements above:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Model</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Raspberry Pi 3 B+</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SOC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Broadcom BCM2837B0, Cortex-A53 (ARMv8) 64-bit SoC</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CPU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.4GHz 64-bit quad-core ARM Cortex-A53 CPU</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RAM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1GB LPDDR2 SDRAM</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WIFI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dual-band 802.11ac wireless LAN (2.4GHz and 5GHz ) and Bluetooth 4.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ethernet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gigabit Ethernet over USB 2.0 (max 300 Mbps). Power-over-Ethernet support (with separate PoE HAT). Improved PXE network and USB ass-storage booting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Thermal management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Video</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes – VideoCore IV 3D. Full-size HDMI</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audio</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">USB 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 ports</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPIO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40-pin</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Power</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5V/2.5A DC power input</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operating system support</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Linux and Unix</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="sensor-board"><a class="anchor" href="#sensor-board"></a>Sensor board</h3>
<div class="paragraph">
<p>Enviro + Air Quality features</p>
</div>
<div class="paragraph">
<p>for this purpose, we used</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>BME280</em>: temperature, pressure, humidity sensor (datasheet)</p>
</li>
<li>
<p><em>LTR-559</em>: light and proximity sensor (datasheet)</p>
</li>
<li>
<p><em>MICS6814</em>: analog gas sensor (datasheet)</p>
</li>
<li>
<p><em>ADS1015</em>: analog to digital converter (ADC) (datasheet)</p>
</li>
<li>
<p><em>MEMS</em>: microphone (datasheet)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="particulate-matter-sensor"><a class="anchor" href="#particulate-matter-sensor"></a>Particulate Matter Sensor</h3>
<div class="paragraph">
<p>For this use-case we picked up a PMS5003</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Index</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unit</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Range of measurement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.3~1.0； 1.0~2.5； 2.5~10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Micrometer（μ m）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counting Efficiency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50%@0.3μ m 98%@&gt;=0.5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">μ m</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Effective Range（PM2.5 standard）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0~500</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">μ g/m³</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum Range（PM2.5standard）*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">≥1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">μ g/m³</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">μ g/m³</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum Consistency Error (PM2.5 standard data)*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">±10%@100~500μ g/m³
±10μ g/m³@0~100μ g/m³</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard Volume</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Litre（L）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single Response Time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">≤10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second（s）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total Response Time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">≤10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second（s）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DC Power Supply</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Typ:5.0 Min:4.5 Max: 5.5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Milliampere（mA）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active Current</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">≤100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Milliampere（mA）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standby Current</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">≤200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microampere（μ A）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface Level</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;0.8 @3.3 H &gt;2.7@3.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Volt（V）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Working Temperature Range</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-10~+60</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">℃</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Working Humidity Range</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0~99%</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Temperature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-40~+80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">℃</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="software"><a class="anchor" href="#software"></a>Software</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The software running on the edge device has a dual purpose:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Integrate with the sensors board and the PMS</p>
</li>
<li>
<p>Interact with the data hub to share collected data</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The business logic of the measurement station has been entirely implemented using cloud-native frameworks and packaged using container technologies.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/edge-device-architecture.png" alt="edge device architecture" width="100%">
</div>
</div>
<div class="sect2">
<h3 id="operating-system"><a class="anchor" href="#operating-system"></a>Operating System</h3>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/logo-fedora-iot.png" alt="logo fedora iot" width="20%">
</div>
</div>
<div class="paragraph">
<p>The operating system matters as well as the services running on it. For the purpose of this implementation, the OS of choice must fulfill the following requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Must be fully-fledged 64 bit OS (not just its kernel)</p>
</li>
<li>
<p>Must have a very small memory footprint</p>
</li>
<li>
<p>Must be immutable or at least, modular</p>
</li>
<li>
<p>Must have the ability to run a container engine with the minimum memory footprint, like Podman or CRI-O</p>
</li>
<li>
<p>Must support all of the following hardware component used by the sensor board:</p>
<div class="ulist">
<ul>
<li>
<p>I2C</p>
</li>
<li>
<p>SMB</p>
</li>
<li>
<p>uart</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>At the moment, the only stable operating system which has all of the characteristics described above is <a href="https://getfedora.org/iot/">Fedora IoT</a>.</p>
</div>
<div class="paragraph">
<p><a href="https://download.fedoraproject.org/pub/alt/iot/33/IoT/aarch64/iso/Fedora-IoT-IoT-ostree-aarch64-33-20210315.0.iso"><strong>Fedora IoT 33</strong></a> must be used in order to have a stable environment as a base for software development for the edge device.</p>
</div>
</div>
<div class="sect2">
<h3 id="sensor-service"><a class="anchor" href="#sensor-service"></a>Sensor Service</h3>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/logo-python.png" alt="logo python" width="10%">
</div>
</div>
<div class="paragraph">
<p>This service exposes apis to connect to sensors and grab raw telemetry and for the Hackfest purposes it must be implemented as containerized service.</p>
</div>
<div class="paragraph">
<p>The technology vendor has put together a <a href="https://github.com/pimoroni/enviroplus-python">Python library</a> to control all the parts of your Enviro and Enviro + Air Quality. To implement the sensor service business logic <span class="underline">Python 3.9+ is highly recommended</span>. That specific version is already  available into the operating system of choice.</p>
</div>
<div class="paragraph">
<p>Lots of examples for each of the individual parts, all-in-one examples that show you the data from the sensors in a visual way are available as well at this <a href="https://github.com/pimoroni/enviroplus-python/tree/master/examples">link</a>.</p>
</div>
<div class="paragraph">
<p>Last, but not least, have a read through the official <a href="https://learn.pimoroni.com/tutorial/sandyj/getting-started-with-enviro-plus">Getting Started with Enviro+ tutorial</a> that walks you through how to install the software, how to run the code examples, and how to use the Python library.</p>
</div>
<div class="paragraph">
<p>The easiest and cheapest way of accessing the sensor service is through unsecured rest API. The Flask project is an excellent and lightweight tool to integrate python rest API with container technology.</p>
</div>
<div class="paragraph">
<p>No need to secure sensor service API, cause this service is designed to be an internal service with no exposure to the network.</p>
</div>
</div>
<div class="sect2">
<h3 id="edge-service"><a class="anchor" href="#edge-service"></a>Edge Service</h3>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/logo-quarkus.png" alt="logo quarkus" width="10%">
</div>
</div>
<div class="paragraph">
<p>The Edge service is responsible for the Data Hub the telemetry collected from the sensors.</p>
</div>
<div class="paragraph">
<p>The main goal of the QIoT Community is to implement this service using Quarkus and to run it natively into a container (possible on 64bit OS only!).</p>
</div>
<div class="paragraph">
<p>Moreover, the Edge Service, as well as the Sensors Service, should have the smallest memory footprint as possible and perform the transactions with the API exposed by the Data Hub in the shortest time.</p>
</div>
<div class="paragraph">
<p>In this scenario, we have the freedom of picking up the programming language of choice.</p>
</div>
<div class="paragraph">
<p>So, thinking of the availability in the IT industry, the best choice at the moment is the Quarkus framework.</p>
</div>
<div class="paragraph">
<p>The Edge service is expected to send one message every 5 seconds.</p>
</div>
<div class="paragraph">
<p>More details about the data flow will be provided in the next chapters.</p>
</div>
</div>
</div>
</div>
<h1 id="datacenter" class="sect0"><a class="anchor" href="#datacenter"></a>Datacenter</h1>
<div class="paragraph">
<p>The Datahub has been designed and implemented by the QIoT technical team and is made up of several services and business logic to manage, store, aggregate and retrieve data.</p>
</div>
<div class="paragraph">
<p>Data types are split into two main categories: <strong>Station</strong> and <strong>Telemetry</strong>.</p>
</div>
<div class="paragraph">
<p>Additionally, a third party data type is stored statically into the datahub in a raw format which is normalized and adapted to the Measurement format every time the QIoT Dashboard service performs a data search.</p>
</div>
<div class="sect1">
<h2 id="main-diagram"><a class="anchor" href="#main-diagram"></a>Main Diagram</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/datacenter-v2.png" alt="datacenter v2" width="100%">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="platform-architecture"><a class="anchor" href="#platform-architecture"></a>Platform architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The infrastructure of the QIoT project must have flexible imprinting and should be easily scalable both horizontally and vertically.
To fulfill the scalability requirements a Cloud-based platform is needed. The only compulsory prerequisite for the cloud provider is OCP certification.</p>
</div>
<div class="paragraph">
<p>A graphical representation of the basic Infrastructure Architecture:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/datacenter-v2-infrastructure.png" alt="datacenter v2 infrastructure" width="100%">
</div>
</div>
<div class="paragraph">
<p>Based on the image above, here is the sizing of the infrastructure provisioned for the Openshift Container Platform:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OCP Control Plane (master nodes)</p>
<div class="ulist">
<ul>
<li>
<p>#Servers: 3</p>
</li>
<li>
<p>CPUs: 8</p>
</li>
<li>
<p>RAM: 24G</p>
</li>
</ul>
</div>
</li>
<li>
<p>OCP Worker Nodes:</p>
<div class="ulist">
<ul>
<li>
<p>#Servers: 3</p>
</li>
<li>
<p>CPUs: 12</p>
</li>
<li>
<p>RAM: 64GB</p>
</li>
</ul>
</div>
</li>
<li>
<p>Storage Server: provides storage functionality to the infrastructure to store data safely and consistently on the disk. There’s no urgent/compulsory need to add this component to the infrastructure architecture, at least at the early stage of the project, because the basic amount of storage provided by the cloud platform would definitely cover all the needs described.</p>
<div class="ulist">
<ul>
<li>
<p>Some additional storage will be needed in case of extended lifetime and participation in the project (i.e. lots more data arriving at the Data Hub). Anyway, just making use of the storage layer from the cloud provider of choice and installing Openshift Container Storage on top of it will guarantee horizontal scalability and data consistency all over the container platform out of the box.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vertical scalability is guaranteed by the could platform.
Horizontal scalability is guaranteed by Openshift by using the auto-scaling feature embedded in the container platform.</p>
</div>
<div class="sect2">
<h3 id="red-hat-openshift-container-platform"><a class="anchor" href="#red-hat-openshift-container-platform"></a>Red Hat Openshift Container Platform</h3>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/Logo-Red_Hat-OpenShift-A-Standard-RGB.png" alt="Logo Red Hat OpenShift A Standard RGB" width="20%">
</div>
</div>
<div class="paragraph">
<p>Red Hat OpenShift is the hybrid cloud platform of open possibility: powerful, so you can build anything and flexible, so it works anywhere.</p>
</div>
<div class="paragraph">
<p>Adopting the Openshift container platform made us save tons of hors implementing features and behaviors supposed to be home cooked, otherwise:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Native pipelines using Tekton</p>
</li>
<li>
<p>One-shot installation using Helm charts</p>
</li>
<li>
<p>2-day operations using Operator Framework</p>
</li>
<li>
<p>Container storage</p>
</li>
<li>
<p>Security and Isolation</p>
</li>
<li>
<p>Automate cluster scalability</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More about Openshift Container Platform can be found <a href="https://www.openshift.com/learn/developer">here</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="software-infrastructure-components"><a class="anchor" href="#software-infrastructure-components"></a>Software infrastructure components</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="a-mq"><a class="anchor" href="#a-mq"></a>A-MQ</h3>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/Logo-Red_Hat-AMQ-A-Standard-RGB.png" alt="Logo Red Hat AMQ A Standard RGB" width="20%">
</div>
</div>
<div class="paragraph">
<p>Exposes the endpoint for the telemetry coming from the measurement stations. The endpoint is exposed through the <a href="https://mqtt.org/">MQTT protocol</a>, protocol of choice for the implementation of IoT architectures.</p>
</div>
<div class="paragraph">
<p>Since it is possible to send two different type of telemetries (pollution and/or gas), The A-MQ broker manages two isolated and scalable topics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>pollution</p>
</li>
<li>
<p>gas</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Technical details about the telemetry and the endpoints to be given in the next chapters.</p>
</div>
<div class="paragraph">
<p>AMQ Broker is a pure-Java multiprotocol message broker. It’s built on an efficient, asynchronous core with a fast native journal for message persistence and the option of shared-nothing state replication for high availability.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Persistence - A fast, native-IO journal or a JDBC-based store</p>
</li>
<li>
<p>High availability - Shared store or shared-nothing state replication</p>
</li>
<li>
<p>Advanced queueing - Last value queues, message groups, topic hierarchies, and large message support</p>
</li>
<li>
<p>Multiprotocol - AMQP 1.0, MQTT, STOMP, OpenWire, and HornetQ Core</p>
</li>
<li>
<p>Integration - Full integration with Red Hat JBoss EAP</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>AMQ Broker is based on the <a href="https://activemq.apache.org/artemis/">Apache ActiveMQ Artemis</a> project.</p>
</div>
</div>
<div class="sect2">
<h3 id="a-mq-streams"><a class="anchor" href="#a-mq-streams"></a>A-MQ Streams</h3>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/logo-strimzi.png" alt="logo strimzi" width="20%">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/logo-kafka.png" alt="logo kafka" width="20%">
</div>
</div>
<div class="paragraph">
<p>In the forecast of the need for receiving/handling a large number of concurrent messages, A-MQ Streams is the component of choice for streaming messages through the integration and the storage layers. An internal streaming service guarantees scalability and reliability of the message flow management within the Datahub business logic.</p>
</div>
<div class="paragraph">
<p>The A-MQ Streams topics have the same design as the A-MQ topics: one topic per telemetry, with the chance to fine tune connections, scalability and message flow and retention separately.</p>
</div>
<div class="paragraph">
<p>This design makes it a lot easier to decouple the implementation details of the integration services responsible for offloading (consuming messages from) every topic and storing the values into the storage tier, improving horizontal scalability.</p>
</div>
<div class="paragraph">
<p>More about A-MQ Streams can be found <a href="https://developers.redhat.com/blog/2019/06/06/accessing-apache-kafka-in-strimzi-part-1-introduction/">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="influx-db"><a class="anchor" href="#influx-db"></a>Influx DB</h3>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/logo-influxdb.png" alt="logo influxdb" width="20%">
</div>
</div>
<div class="paragraph">
<p>Timeseries database engines are the technology of choice to store the telemetry coming from the IoT devices in an Edge Computing scenario.</p>
</div>
<div class="paragraph">
<p>For this usecase we have picked up Influxdb, as it guarantees, scalability, reliability and a level of performances not achievable using other competitors on the market.</p>
</div>
<div class="paragraph">
<p>Moreover, InfluxDB is the essential time series toolkit — dashboards, queries, tasks and agents all in one place.</p>
</div>
<div class="paragraph">
<p>As well as for the previous software infrastructure components used to receive and stream data, we have decided to go for a separation by telemetry-time.</p>
</div>
<div class="paragraph">
<p>More about InfluxDB can be found <a href="https://www.influxdata.com/products/influxdb/">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="postgresql"><a class="anchor" href="#postgresql"></a>PostgreSQL</h3>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/logo-postgresql.png" alt="logo postgresql" width="10%">
</div>
</div>
<div class="paragraph">
<p>PostgreSQL is a powerful, open source object-relational database system with over 30 years of active development that has earned it a strong reputation for reliability, feature robustness, and performance.</p>
</div>
<div class="paragraph">
<p>The relational database engine is used to store non-timeseries data like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Measurement Station data</p>
</li>
<li>
<p>Third-party station data</p>
</li>
<li>
<p>Aggregated third-party measurements</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More about PostgreSQL can be found <a href="https://www.postgresql.org/">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="cert-manager"><a class="anchor" href="#cert-manager"></a>Cert-manager</h3>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/logo-cert-manager.png" alt="logo cert manager" width="10%">
</div>
</div>
<div class="paragraph">
<p>Cert-manager automates certificate management in cloud native environments and thus helped with the implementation of a dynamic certificate provisioning for edge devices</p>
</div>
<div class="paragraph">
<p>cert-manager builds on top of Kubernetes, introducing certificate authorities and certificates as first-class resource types in the Kubernetes API.</p>
</div>
<div class="paragraph">
<p>This makes it possible to provide 'certificates as a service' to developers working within your Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>Highlights</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provide easy to use tools to manage certificates.</p>
</li>
<li>
<p>A standardised API for interacting with multiple certificate authorities (CAs).</p>
</li>
<li>
<p>Gives security teams the confidence to allow developers to self-server certificates.</p>
</li>
<li>
<p>Support for ACME (Let&#8217;s Encrypt), HashiCorp Vault, Venafi, self signed and internal certificate authorities.</p>
</li>
<li>
<p>Extensible to support custom, internal or otherwise unsupported CAs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More about out cert-manager implementation <a href="https://qiot-project.github.io/blog/qiot-cert-manager/">here</a></p>
</div>
<div class="paragraph">
<p>More about Cert-Manageranager can be found <a href="https://cert-manager.io/">here</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="business-logic-architecture"><a class="anchor" href="#business-logic-architecture"></a>Business logic architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Datahub business logic is build on top of Quarkus framework. All the services run natively on top of the container technology and benefit from the features from the Serverless architecture.</p>
</div>
<div class="paragraph">
<p>A separate discussion must be done for the Dashboard, which exposes diagrams based on the telemetry coming from the measurement stations and in implemented on top of RedHat build of Node.js</p>
</div>
<div class="sect2">
<h3 id="registration-service"><a class="anchor" href="#registration-service"></a>Registration Service</h3>
<div class="paragraph">
<p>Microservice implemented on top of the Quarkus Framework.</p>
</div>
<div class="paragraph">
<p>This service is compiled and runs in native mode.</p>
</div>
<div class="paragraph">
<p>It&#8217;s responsible for the management of the Edge Device in the ecosystem.</p>
</div>
<div class="paragraph">
<p>It exposes a rest API secured with mutual authentication. details about the exposed endpoints are available in the <a href="#specs">Specs</a> section</p>
</div>
<div class="paragraph">
<p>More details can be found in the <a href="https://github.com/qiot-project/qiot-datahub-registration/tree/v2">dedicated repository</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="station-service"><a class="anchor" href="#station-service"></a>Station Service</h3>
<div class="paragraph">
<p>Microservice implemented on top of the Quarkus Framework.</p>
</div>
<div class="paragraph">
<p>It&#8217;s responsible for the management of the Edge Device data.</p>
</div>
<div class="paragraph">
<p>Data are stored in PostgreSQL to take advantage of the CRUD operations.</p>
</div>
<div class="paragraph">
<p>As this service is used by the Collectors to enrich the incoming telemetry, the data are locally cached using a 2nd level cache</p>
</div>
<div class="paragraph">
<p>More details can be found in the <a href="https://github.com/qiot-project/qiot-datahub-station">dedicated repository</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="localization-service"><a class="anchor" href="#localization-service"></a>Localization Service</h3>
<div class="paragraph">
<p>Microservice implemented on top of the Quarkus Framework.</p>
</div>
<div class="paragraph">
<p>Simple route to convert the coordinates sent by the Measurement station at registration time.</p>
</div>
<div class="paragraph">
<p>In order to perform the Reverse Geocoding, the service calls the REST APIs exposed by a third party service: <a href="https://nominatim.org/release-docs/latest/api/Reverse/#examples">Nominatim</a> by OpenStreetMap</p>
</div>
</div>
<div class="sect2">
<h3 id="pollutiongas-collector"><a class="anchor" href="#pollutiongas-collector"></a>Pollution/Gas Collector</h3>
<div class="paragraph">
<p>Microservice implemented on top of the Quarkus Framework.</p>
</div>
<div class="paragraph">
<p>This service is compiled and runs in native mode.</p>
</div>
<div class="paragraph">
<p>This service is responsible for validating/enriching/storing the raw telemetry coming from the stations.</p>
</div>
<div class="paragraph">
<p>The main reason why we&#8217;ve split the two services is for scalability and extensibility purposes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Thanks to the <a href="https://github.com/qiot-project/qiot-datahub-collector/tree/main/qiot-datahub-collector-commons">Commons module</a>, it&#8217;s easy to extend the group of services to make them accept an additional telemetry type;</p>
</li>
<li>
<p>As the frequency of incoming messages per telemetry type can vary, scaling feature affects only one service in the group;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More details can be found in the <a href="https://github.com/qiot-project/qiot-datahub-collector">dedicated repository</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="pollutiongas-storer"><a class="anchor" href="#pollutiongas-storer"></a>Pollution/Gas Storer</h3>
<div class="paragraph">
<p>Microservice implemented on top of the Quarkus Framework.</p>
</div>
<div class="paragraph">
<p>This service is responsible for store the messages consumed from the A-MQ Streams component into the time-series database.</p>
</div>
<div class="paragraph">
<p>The main reaso why we&#8217;ve split the two services is for scalability and extensibility purposes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Thanks to the <a href="https://github.com/qiot-project/qiot-datahub-storer/tree/v2/qiot-datahub-storer-commons">Commons module</a>, it&#8217;s easy to extend the group of services to make them accept an additional telemetry type;</p>
</li>
<li>
<p>As the frequency of incoming messages per telemetry type can vary, scaling feature affects only one service in the group;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Due to the incompatibility of the <a href="https://github.com/influxdata/influxdb-client-java">Java Client for InfluxDB</a> with Quarkus native mode, the service is compiled using the standard java fast-jar mode.</p>
</div>
<div class="paragraph">
<p>More details can be found in the <a href="https://github.com/qiot-project/qiot-datahub-storer/tree/v2">dedicated repository</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="importer-service"><a class="anchor" href="#importer-service"></a>Importer Service</h3>
<div class="paragraph">
<p>Microservice implemented on top of the Quarkus Framework.</p>
</div>
<div class="paragraph">
<p>This service is compiled and runs in native mode.</p>
</div>
<div class="paragraph">
<p>This service is responsible for importing the data from third-party services directly into the relational database.</p>
</div>
<div class="paragraph">
<p>More details can be found in the <a href="https://github.com/qiot-project/qiot-datahub-storer/tree/v2">dedicated repository</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="real-time-dashboard"><a class="anchor" href="#real-time-dashboard"></a>Real-time Dashboard</h3>
<div class="paragraph">
<p>WIP</p>
</div>
</div>
<div class="sect2">
<h3 id="dashboard"><a class="anchor" href="#dashboard"></a>Dashboard</h3>
<div class="paragraph">
<p>WIP</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="functional-overview"><a class="anchor" href="#functional-overview"></a>Functional Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections give an overview of the business logic implemented through the interaction between the microservices described above:</p>
</div>
<div class="sect2">
<h3 id="registration-phase"><a class="anchor" href="#registration-phase"></a>Registration phase</h3>
<div class="paragraph">
<p>The registration phase of the COVID-19 use-case implementation is a key component of the overall business logic</p>
</div>
<div class="paragraph">
<p>It is actually the entry-level functionality for each and every edge device willing to connect and send the telemetry to the datacenter.</p>
</div>
<div class="paragraph">
<p>As the endpoint is secured via mutual authentication, the client is supposed to use the certificates or key-/trust- store pair available in the registration service repository at this <a href="https://github.com/qiot-project/qiot-datahub-registration/tree/v2/src/main/resources/certs">link</a>.</p>
</div>
<div class="paragraph">
<p>Once a register request has been received by the service, it performs the following actions within a single transaction:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provisions a new key-/trust- store pair for the MQTT endpoint</p>
<div class="ulist">
<ul>
<li>
<p>Contacts the cert-issues deployed by cert-manager into the project namespace, asking for a certificate belonging to the service domain.</p>
</li>
<li>
<p>Encrypt the content of both the keystore and the truststore to make it safely deliverable back to the caller in the response data</p>
</li>
</ul>
</div>
</li>
<li>
<p>Asks the <a href="#station-service">Station Service</a> to persist the data of the new measurement station.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If one of the two main actions fail, the operation is rolled back entirely.</p>
</div>
<div class="paragraph">
<p><strong>BEWARE</strong>: it&#8217;s not allowed to delete an existing measurement station. We decided to adhere to the standard behavior of an IoT/Edge Computing system where a certificate/registration gets revoked only in case of a cyber attack to the registered device</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/datacenter-v2-registration.png" alt="datacenter v2 registration" width="75%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="telemetry-production"><a class="anchor" href="#telemetry-production"></a>Telemetry production</h3>
<div class="paragraph">
<p>The edge device produces MQTT messages containing the telemetry collected through its sensors.</p>
</div>
<div class="paragraph">
<p>ATM, we the use-case implementation exposes two endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>gas</p>
</li>
<li>
<p>pollution</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to connect to the MQTT endpoints exposed by the A-MQ broker, the client implemented on the edge side must use the key- / trust- store pairs received by the registration service.
Thos ingo get validated by the CA connected to A-MQ and thus must belong to the COVID-19 domain</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/datacenter-v2-telemetry-production.png" alt="datacenter v2 telemetry production" width="75%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="telemetry-validation-and-enrichment"><a class="anchor" href="#telemetry-validation-and-enrichment"></a>Telemetry validation and enrichment</h3>
<div class="paragraph">
<p>In order to reduce the network traffic and improve the process of transmitting data through the network, the data contained in the telemetry must be reduced to the minimum meaningful information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Station ID</p>
</li>
<li>
<p>instant</p>
</li>
<li>
<p>telemetry-specific data</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>for each and every of those key/value pair we implemented a validator, implicit or esplicit, that checks the data as umarshal-time.</p>
</div>
<div class="paragraph">
<p>The above is possible using the mashalling/unmarshalling features coming with the java-based json libraries belonging to the Quarkus Universe.</p>
</div>
<div class="paragraph">
<p>The data contained in the telemetry sent by the edge device are, indeed, not complete/extended enough for a dashboard or analytic process and thus we went for the implementation of a route-like service which validates and enriches the incoming telemetry.</p>
</div>
<div class="paragraph">
<p>For each and every telemetry belonging to its specific domain, the <a href="#Collector Service">[Collector Service]</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>validates the telemetry unmarshalling the raw string;</p>
</li>
<li>
<p>connects to the <a href="#station-service">Station Service</a> to gather the data to enrich the data object;</p>
</li>
<li>
<p>marshals the enriched object into a json-based string</p>
</li>
<li>
<p>produces a new message to the internal streaming service;</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/datacenter-v2-telemetry-validation-enrichment.png" alt="datacenter v2 telemetry validation enrichment" width="75%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="scalability-of-the-data-flow"><a class="anchor" href="#scalability-of-the-data-flow"></a>Scalability of the data-flow</h3>
<div class="paragraph">
<p>The main function of A-MQ streams is to provide to the entire namespace (and, eventually, to other namespaces requesting access to the internal data) a scalable dataflow management system.
In the diagram snippet below, you can see how scalability works in terms of streaming service and consumers of the telemetry.</p>
</div>
<div class="paragraph">
<p>It would definitely be easier to develop the connection between datasource and database using plugin, but would definitely cut off most of the enterprise grade features a system must definitely have.</p>
</div>
<div class="paragraph">
<p>The scalability concept applies to the <a href="#Storer Service">[Storer Service]</a> exactly in the same way it applies to the collectors.</p>
</div>
<div class="paragraph">
<p>Each storer service is responsible for its specific data and is just one example of subscriber from the platform extensibility perspective.</p>
</div>
<div class="paragraph">
<p>About the timeseries database, we decided to go for une bucket and two different series, dedicated to each telemetry.</p>
</div>
<div class="paragraph">
<p>An additional telemetry would require a new series to be created.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/datacenter-v2-dataflow.png" alt="datacenter v2 dataflow" width="75%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="data-view"><a class="anchor" href="#data-view"></a>Data view</h3>
<div class="paragraph">
<p>WIP</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/posts/usecase-covid-19/datacenter-v2-view.png" alt="datacenter v2 view" width="75%">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="specs"><a class="anchor" href="#specs"></a>Specs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="registration-service-2"><a class="anchor" href="#registration-service-2"></a>Registration Service</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
openapi: 3.0.2
info:
  title: QioT - Registration Service
  description: Registration Service
  version: 1.0.0
paths:
  /register:
    summary: Path used to manage the list of registerrequests.
    description: "The REST endpoint/path used to list and create zero or more `RegisterRequest`\
      \ entities.  This path contains a `GET` and `POST` operation to perform the\
      \ list and create tasks, respectively."
    post:
      summary: Create a RegisterRequest
      description: Creates a new instance of a `RegisterRequest`.
      operationId: createRegisterRequest
      requestBody:
        description: A new `RegisterRequest` to be created.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
        required: true
      responses:
        "201":
          description: Successful response.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
  /register/{id}:
    summary: Path used to manage a single RegisterRequest.
    description: "The REST endpoint/path used to get, update, and delete single instances\
      \ of an `RegisterRequest`.  This path contains `GET`, `PUT`, and `DELETE` operations\
      \ used to perform the get, update, and delete tasks, respectively."
    get:
      summary: Get a RegisterRequest
      description: Gets the details of a single instance of a `RegisterRequest`.
      operationId: getRegisterRequest
      responses:
        "200":
          description: Successful response - returns a single `RegisterResponse`.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
  /v1/register:
    post:
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        "200":
          description: OK
components:
  schemas:
    RegisterRequest:
      title: Root Type for RegisterRequest
      description: ""
      type: object
      properties:
        serial:
          type: string
        name:
          type: string
        longitude:
          format: double
          type: number
        latitude:
          format: double
          type: number
        keyStorePassword:
          description: KeyStore Password
          type: string
      example:
        serial: some text
        name: some text
        longitude: 3.6
        latitude: 29.41
        keyStorePassword: some text
    RegisterResponse:
      description: ""
      required:
      - id
      - truststore
      - keystore
      type: object
      properties:
        id:
          description: ""
          type: string
        truststore:
          format: byte
          description: ""
          type: string
        keystore:
          format: byte
          description: ""
          type: string
      example:
        id: some text
        truststore: &lt;FILE&gt;
        keystore: &lt;FILE&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>RegisterRequest</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>serial</strong> must be a standard Raspberry Pi ID. More info <a href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/otpbits.md">here</a></p>
</li>
<li>
<p><strong>name</strong> must be a single, lowercase word, validated using the regex</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>"[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*"</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>longitude</strong> and <strong>latitude</strong> must be standard coordinate values. we recommend to use the <a href="https://nominatim.openstreetmap.org/ui/search.html">Nominatim</a> service by OpenStreetMap</p>
<div class="ulist">
<ul>
<li>
<p><strong>RegisterResponse</strong></p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>id</strong> is the final/unique identification string of the measurement station and is string representation of an immutable universally unique identifier (UUID). The value must be embedded in each and every telemetry sent to the MQTT endpoints</p>
</li>
<li>
<p><strong>truststore</strong> and <strong>keystore</strong> are string representation of the encrypted content for each store. We recommend to decrypt them on the edge device using the following code snippet:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>...
import java.util.Base64;

...

byte[] content = Base64.getDecoder().decode(encodedString.getBytes(StandardCharsets.UTF_8));</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pollution"><a class="anchor" href="#pollution"></a>Pollution</h3>
<div class="paragraph">
<p>PMS5003 output explained (<a href="https://learn.pimoroni.com/tutorial/sandyj/getting-started-with-enviro-plus">source</a>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json"> {
    "stationId":string*,
    "instant":string**,
    "PM1_0":int,
    "PM2_5":int,
    "PM10":int,
    "PM1_0_atm":int,
    “PM2_5_atm":int,
    "PM10_atm":int,
    "gt0_3um":int,
    "gt0_5um":int,
    "gt1_0um":int,
    "gt2_5um":int,
    "gt5_0um":int
    "gt10um":int
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>(*) The instant value must be a string representation of an immutable universally unique identifier (UUID).</p>
</div>
<div class="paragraph">
<p>(**) The instant value must be a string representation of an instant using <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO-8601</a> representation</p>
</div>
<div class="paragraph">
<p>And example of expected values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{"stationId":3,"instant":"2020-09-07T10:01:42.002818Z","gt0_3um":21366,"gt0_5um":5774,"gt1_0um":14,"gt2_5um":1355,"gt5_0um":126,"gt10um":59,"pm1_0":240,"pm2_5":156,"pm10":114,"pm1_0_atm":81,"pm2_5_atm":204,"pm10_atm":134}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="gas"><a class="anchor" href="#gas"></a>Gas</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "stationId":int,
    "instant":string*,
    "adc":double,
    "nh3":double,
    “oxidising":double,
    "reducing":double
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>(*) The instant value must be a string representation of an immutable universally unique identifier (UUID).</p>
</div>
<div class="paragraph">
<p>(**) The instant value must be a string representation of an instant using <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO-8601</a> representation</p>
</div>
<div class="paragraph">
<p>And example of expected values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{"stationId":0,"instant":2020-09-07T10:01:42.002818Z,"adc":128431.13772455092,"nh3":192387.0967741936,"oxidising":10594.594594594595,"reducing":192387.0967741936}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="historical-data"><a class="anchor" href="#historical-data"></a>Historical data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to perform a proper analysis between current and previous air quality,we decided to import into the centralized system a bunch of historical data coming from a global air quality system: <a href="https://waqi.info/">WAQI</a></p>
</div>
<div class="paragraph">
<p>The raw data source can be found <a href="https://aqicn.org/data-platform/covid19/">here</a>.</p>
</div>
</div>
</div>
<h1 id="how-to-reproduce" class="sect0"><a class="anchor" href="#how-to-reproduce"></a>How to reproduce</h1>
<div class="paragraph">
<p>you can spin up the overall environment on a standard Docker environment.
We distribute docker-compose files in this <a href="https://github.com/qiot-project/qiot-datahub-docker/tree/v2">repository</a>.</p>
</div>

        <div id="share-bar">

    <hr>

    <h4>Share this:</h4>

    <div class="share-buttons">
        <a  href="https://www.facebook.com/sharer/sharer.php?u=/blog/usecase-covid-19/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Facebook" >
            <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
              </span>
        </a>
        <a  href="https://twitter.com/intent/tweet?text=PoC covid19&url=/blog/usecase-covid-19/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Twitter" >
            <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
        </a>
        <a  href="http://www.reddit.com/submit?url=/blog/usecase-covid-19/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Reddit" >
            <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-reddit fa-stack-1x fa-inverse"></i>
              </span>
        </a>
        <a  href="https://www.linkedin.com/shareArticle?mini=true&url=/blog/usecase-covid-19/&title=PoC covid19&summary=&source=QIoT project"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on LinkedIn" >
            <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
        </a>
        <a  href="mailto:?subject=PoC covid19&amp;body=Check out this site /blog/usecase-covid-19/"
            title="Share via Email" >
            <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
        </a>
    </div>

</div>

        <hr>

<!--         <div class="clearfix"> -->
<!--            -->
<!--           <a class="btn btn-primary float-left" href="/blog/qiot-hackfest-at-openshift-tv/" data-toggle="tooltip" data-placement="top" title="QIoT Hackfest Pilot @ Openshift tv">&larr; Previous<span class="d-none d-md-inline"> -->
<!--               Post</span></a> -->
<!--            -->
<!--            -->
<!--           <a class="btn btn-primary float-right" href="/blog/qiot-hackfest-at-openshift-tv-updates/" data-toggle="tooltip" data-placement="top" title="QIoT Hackfest @ Openshift tv - updates">Next<span class="d-none d-md-inline"> -->
<!--               Post</span> &rarr;</a> -->
<!--            -->

	  
	  
	  
	  

        <div class="clearfix">
          
          
          <a class="btn btn-primary float-right" href="/blog/usecase-manufacturing/" data-toggle="tooltip" data-placement="top" title="PoC Edge Manufacturing">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          
        </div>

      </div>
    </div>
  </div>

  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-16 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:qiotproject@gmail.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://twitter.com/qiotproject">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          
          <li class="list-inline-item">
            <a href="https://github.com/qiot-project">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          <li class="list-inline-item">
            <a href="https://join.slack.com/t/https://join.slack.com/t/qiotproject/shared_invite/zt-nuajdyqf-NfQL0dcfCUjFSgoBNng11A">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-slack fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://groups.google.com/u/0/g/qiotproject/qiotproject">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-google fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://calendar.google.com/event?action=TEMPLATE&tmeid=dmFxMzFlZGkxOHVubDcyYm50bjdrcTJxYThfMjAyMTAzMjVUMTYwMDAwWiBxaW90cHJvamVjdEBt&tmsrc=qiotproject%40gmail.com&scp=ALL">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-calendar-plus fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="copyright text-muted"><i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a> | Copyright &copy;  2024</p>
      </div>
    </div>
  </div>
</footer>

  <script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/clean-blog.min.js"></script>

<script src="/assets/scripts.js"></script>




</body>

</html>
